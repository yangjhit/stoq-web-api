# 用户登录指南
用户注册、登录、密码重置和Token管理的完整指南。

## 目录

1. [概览](#概览)
2. [用户注册](#用户注册)
3. [用户登录](#用户登录)
4. [密码重置](#密码重置)
5. [Token管理](#token管理)
6. [完整API测试流程](#完整api测试流程)
7. [错误处理](#错误处理)
8. [安全最佳实践](#安全最佳实践)

---

## 概览

Stoq API提供了完整的身份验证系统,具有以下特性:

- ✅ 邮箱验证的用户注册
- ✅ JWT Token的安全登录
- ✅ 验证码重置密码
- ✅ Token刷新延长会话
- ✅ BCrypt密码加密
- ✅ Redis验证码存储
- ✅ 场景化验证码(REGISTER、RESET_PASSWORD)

### 主要端点

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/users/send-verification-code` | 发送验证码到邮箱 |
| GET | `/api/users/get-verification-code` | 获取验证码(仅开发) |
| POST | `/api/users/register` | 注册新用户 |
| POST | `/api/users/login` | 用邮箱和密码登录 |
| POST | `/api/users/reset-password` | 用验证码重置密码 |
| POST | `/api/users/refresh-token` | 刷新JWT Token |
| GET | `/api/users` | 获取所有用户 |
| GET | `/api/users?email=xxx` | 根据邮箱获取用户 |
| PUT | `/api/users?email=xxx` | 更新用户信息 |
| DELETE | `/api/users?email=xxx` | 删除用户账户 |

---

## 用户注册

### 步骤1: 发送验证码

向用户邮箱发送验证码。

**请求:**
```bash
curl -X POST http://localhost:8080/api/users/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "scenario": "REGISTER"
  }'
```

**请求体:**
```json
{
  "email": "user@example.com",
  "scenario": "REGISTER"
}
```

**响应 (200 OK):**
```json
{
  "scenario": "REGISTER",
  "message": "Verification code sent to: user@example.com",
  "email": "user@example.com"
}
```

**验证规则:**
- 邮箱必须是有效格式
- 场景必须是"REGISTER"或"RESET_PASSWORD"

---

### 步骤2: 获取验证码(仅开发)

用于开发和测试,获取已发送的验证码。

**请求:**
```bash
curl "http://localhost:8080/api/users/get-verification-code?email=user@example.com&scenario=REGISTER"
```

**查询参数:**
- `email` (必需): 用户邮箱地址
- `scenario` (必需): 验证码场景(REGISTER或RESET_PASSWORD)

**响应 (200 OK):**
```json
{
  "scenario": "REGISTER",
  "message": "Verification code retrieved successfully",
  "email": "user@example.com",
  "verificationCode": "123456"
}
```

**响应 (404 Not Found):**
```json
{
  "status": 404,
  "message": "Verification code not found, please send it first",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

---

### 步骤3: 注册用户

用验证码创建新用户账户。

**请求:**
```bash
curl -X POST http://localhost:8080/api/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "avatar": "https://example.com/avatar.jpg",
    "name": "张",
    "surName": "三",
    "age": 25,
    "email": "user@example.com",
    "phone": "+86 13800000001",
    "country": "中国",
    "city": "北京",
    "password": "Password123",
    "verificationCode": "123456"
  }'
```

**请求体:**
```json
{
  "avatar": "https://example.com/avatar.jpg",
  "name": "张",
  "surName": "三",
  "age": 25,
  "email": "user@example.com",
  "phone": "+86 13800000001",
  "country": "中国",
  "city": "北京",
  "password": "Password123",
  "verificationCode": "123456"
}
```

**验证规则:**
- 名字: 1-50个字符,必需
- 姓氏: 1-50个字符,必需
- 年龄: 1-150,必需
- 邮箱: 有效邮箱格式,必需,唯一
- 电话: 8-20个字符,必需
- 国家: 2-100个字符,必需
- 城市: 2-100个字符,必需
- 密码: 6-50个字符,必须包含大小写字母和数字
- 验证码: 6位数字,必需

**响应 (201 Created):**
```json
{
  "email": "user@example.com",
  "avatar": "https://example.com/avatar.jpg",
  "name": "张",
  "surName": "三",
  "age": 25,
  "phone": "+86 13800000001",
  "country": "中国",
  "city": "北京",
  "createdAt": "2025-11-16T11:16:58.400862",
  "updatedAt": "2025-11-16T11:16:58.400863"
}
```

**错误响应 (400 Bad Request):**
```json
{
  "status": 400,
  "message": "Validation failed: Password must contain uppercase, lowercase letters and numbers",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

**错误响应 (409 Conflict):**
```json
{
  "status": 409,
  "message": "Email already exists: user@example.com",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

---

## 用户登录

### 用邮箱和密码登录

验证用户身份并获取JWT Token。

**请求:**
```bash
curl -X POST http://localhost:8080/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "Password123"
  }'
```

**请求体:**
```json
{
  "email": "user@example.com",
  "password": "Password123"
}
```

**验证规则:**
- 邮箱: 有效邮箱格式,必需
- 密码: 不能为空,必需

**响应 (200 OK):**
```json
{
  "message": "Login successful",
  "user": {
    "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYzMjYzMDI5LCJleHAiOjE3NjMzNDk0Mjl9.F5xVpjdYiGN_8_TL5PIm2ijg5AyUiXLrg6M6GkJN4D2KG3f-s-d4LuOgzxygvuy8Qbv2eWwkY9UY_RaBDpkWLQ",
    "email": "user@example.com",
    "name": "张",
    "surName": "三",
    "age": 25,
    "phone": "+86 13800000001",
    "country": "中国",
    "city": "北京",
    "avatar": "https://example.com/avatar.jpg",
    "createdAt": "2025-11-16T11:16:58.400862",
    "updatedAt": "2025-11-16T11:16:58.400863"
  },
  "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYzMjYzMDI5LCJleHAiOjE3NjMzNDk0Mjl9.F5xVpjdYiGN_8_TL5PIm2ijg5AyUiXLrg6M6GkJN4D2KG3f-s-d4LuOgzxygvuy8Qbv2eWwkY9UY_RaBDpkWLQ"
}
```

**错误响应 (404 Not Found):**
```json
{
  "status": 404,
  "message": "Invalid email or password",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

### Token信息

JWT Token包含以下信息:
- `sub`: 用户邮箱
- `iat`: 签发时间戳
- `exp`: 过期时间戳(签发后24小时)

**Token有效期:** 24小时

**在请求中使用Token:**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  http://localhost:8080/api/users
```

---

## 密码重置

### 步骤1: 发送重置密码验证码

发送用于密码重置的验证码。

**请求:**
```bash
curl -X POST http://localhost:8080/api/users/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "scenario": "RESET_PASSWORD"
  }'
```

**请求体:**
```json
{
  "email": "user@example.com",
  "scenario": "RESET_PASSWORD"
}
```

**响应 (200 OK):**
```json
{
  "scenario": "RESET_PASSWORD",
  "message": "Verification code sent to: user@example.com",
  "email": "user@example.com"
}
```

---

### 步骤2: 获取重置密码验证码(仅开发)

**请求:**
```bash
curl "http://localhost:8080/api/users/get-verification-code?email=user@example.com&scenario=RESET_PASSWORD"
```

**响应 (200 OK):**
```json
{
  "scenario": "RESET_PASSWORD",
  "message": "Verification code retrieved successfully",
  "email": "user@example.com",
  "verificationCode": "654321"
}
```

---

### 步骤3: 重置密码

用验证码重置用户密码。

**请求:**
```bash
curl -X POST http://localhost:8080/api/users/reset-password \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "newPassword": "NewPassword456",
    "confirmPassword": "NewPassword456",
    "verificationCode": "654321"
  }'
```

**请求体:**
```json
{
  "email": "user@example.com",
  "newPassword": "NewPassword456",
  "confirmPassword": "NewPassword456",
  "verificationCode": "654321"
}
```

**验证规则:**
- 邮箱: 有效邮箱格式,必需
- 新密码: 6-50个字符,必须包含大小写字母和数字
- 确认密码: 必须与新密码一致
- 验证码: 6位数字,必需

**响应 (200 OK):**
```json
{
  "message": "Password reset successfully, please login with new password",
  "email": "user@example.com"
}
```

**错误响应 (400 Bad Request):**
```json
{
  "status": 400,
  "message": "Passwords do not match",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

**错误响应 (404 Not Found):**
```json
{
  "status": 404,
  "message": "Verification code not found or expired",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

---

## Token管理

### 刷新Token

获取新的Token,延长有效期。

**请求:**
```bash
curl -X POST http://localhost:8080/api/users/refresh-token \
  -H "Content-Type: application/json" \
  -d '{
    "token": "eyJhbGciOiJIUzUxMiJ9..."
  }'
```

**请求体:**
```json
{
  "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYzMjYzMDI5LCJleHAiOjE3NjMzNDk0Mjl9.F5xVpjdYiGN_8_TL5PIm2ijg5AyUiXLrg6M6GkJN4D2KG3f-s-d4LuOgzxygvuy8Qbv2eWwkY9UY_RaBDpkWLQ"
}
```

**响应 (200 OK):**
```json
{
  "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYzMjYzMDI5LCJleHAiOjE3NjMzNDk0Mjl9.F5xVpjdYiGN_8_TL5PIm2ijg5AyUiXLrg6M6GkJN4D2KG3f-s-d4LuOgzxygvuy8Qbv2eWwkY9UY_RaBDpkWLQ",
  "message": "Token refreshed successfully, new token valid for 24 hours"
}
```

**错误响应 (500 Internal Server Error):**
```json
{
  "status": 500,
  "message": "Token is invalid or expired, cannot refresh",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

---

## 完整API测试流程

### 完整用户旅程: 注册 → 登录 → 重置密码 → 再次登录

#### 1. 发送注册验证码

```bash
curl -X POST http://localhost:8080/api/users/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{
    "email": "newuser@example.com",
    "scenario": "REGISTER"
  }'
```

**预期输出:**
```json
{
  "scenario": "REGISTER",
  "message": "Verification code sent to: newuser@example.com",
  "email": "newuser@example.com"
}
```

---

#### 2. 获取验证码(开发)

```bash
curl "http://localhost:8080/api/users/get-verification-code?email=newuser@example.com&scenario=REGISTER"
```

**预期输出:**
```json
{
  "scenario": "REGISTER",
  "message": "Verification code retrieved successfully",
  "email": "newuser@example.com",
  "verificationCode": "123456"
}
```

**保存验证码: `123456`**

---

#### 3. 注册用户

```bash
curl -X POST http://localhost:8080/api/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "avatar": "https://example.com/avatar.jpg",
    "name": "张",
    "surName": "三",
    "age": 30,
    "email": "newuser@example.com",
    "phone": "+86 13800000001",
    "country": "中国",
    "city": "北京",
    "password": "Password123",
    "verificationCode": "123456"
  }'
```

**预期输出:**
```json
{
  "email": "newuser@example.com",
  "avatar": "https://example.com/avatar.jpg",
  "name": "张",
  "surName": "三",
  "age": 30,
  "phone": "+86 13800000001",
  "country": "中国",
  "city": "北京",
  "createdAt": "2025-11-16T11:16:58.400862",
  "updatedAt": "2025-11-16T11:16:58.400863"
}
```

---

#### 4. 用原密码登录

```bash
curl -X POST http://localhost:8080/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "newuser@example.com",
    "password": "Password123"
  }'
```

**预期输出:**
```json
{
  "message": "Login successful",
  "user": {
    "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJuZXd1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYzMjYzMDI5LCJleHAiOjE3NjMzNDk0Mjl9.F5xVpjdYiGN_8_TL5PIm2ijg5AyUiXLrg6M6GkJN4D2KG3f-s-d4LuOgzxygvuy8Qbv2eWwkY9UY_RaBDpkWLQ",
    "email": "newuser@example.com",
    "name": "张",
    "surName": "三",
    "age": 30,
    "phone": "+86 13800000001",
    "country": "中国",
    "city": "北京",
    "avatar": "https://example.com/avatar.jpg",
    "createdAt": "2025-11-16T11:16:58.400862",
    "updatedAt": "2025-11-16T11:16:58.400863"
  },
  "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJuZXd1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYzMjYzMDI5LCJleHAiOjE3NjMzNDk0Mjl9.F5xVpjdYiGN_8_TL5PIm2ijg5AyUiXLrg6M6GkJN4D2KG3f-s-d4LuOgzxygvuy8Qbv2eWwkY9UY_RaBDpkWLQ"
}
```

**保存Token供后续使用**

---

#### 5. 发送重置密码验证码

```bash
curl -X POST http://localhost:8080/api/users/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{
    "email": "newuser@example.com",
    "scenario": "RESET_PASSWORD"
  }'
```

**预期输出:**
```json
{
  "scenario": "RESET_PASSWORD",
  "message": "Verification code sent to: newuser@example.com",
  "email": "newuser@example.com"
}
```

---

#### 6. 获取重置密码验证码(开发)

```bash
curl "http://localhost:8080/api/users/get-verification-code?email=newuser@example.com&scenario=RESET_PASSWORD"
```

**预期输出:**
```json
{
  "scenario": "RESET_PASSWORD",
  "message": "Verification code retrieved successfully",
  "email": "newuser@example.com",
  "verificationCode": "654321"
}
```

**保存验证码: `654321`**

---

#### 7. 重置密码

```bash
curl -X POST http://localhost:8080/api/users/reset-password \
  -H "Content-Type: application/json" \
  -d '{
    "email": "newuser@example.com",
    "newPassword": "NewPassword456",
    "confirmPassword": "NewPassword456",
    "verificationCode": "654321"
  }'
```

**预期输出:**
```json
{
  "message": "Password reset successfully, please login with new password",
  "email": "newuser@example.com"
}
```

---

#### 8. 尝试用旧密码登录(应该失败)

```bash
curl -X POST http://localhost:8080/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "newuser@example.com",
    "password": "Password123"
  }'
```

**预期输出(错误):**
```json
{
  "status": 404,
  "message": "Invalid email or password",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

---

#### 9. 用新密码登录(应该成功)

```bash
curl -X POST http://localhost:8080/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "newuser@example.com",
    "password": "NewPassword456"
  }'
```

**预期输出:**
```json
{
  "message": "Login successful",
  "user": {
    "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJuZXd1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYzMjYzMDI5LCJleHAiOjE3NjMzNDk0Mjl9.F5xVpjdYiGN_8_TL5PIm2ijg5AyUiXLrg6M6GkJN4D2KG3f-s-d4LuOgzxygvuy8Qbv2eWwkY9UY_RaBDpkWLQ",
    "email": "newuser@example.com",
    "name": "张",
    "surName": "三",
    "age": 30,
    "phone": "+86 13800000001",
    "country": "中国",
    "city": "北京",
    "avatar": "https://example.com/avatar.jpg",
    "createdAt": "2025-11-16T11:16:58.400862",
    "updatedAt": "2025-11-16T11:16:58.400863"
  },
  "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJuZXd1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYzMjYzMDI5LCJleHAiOjE3NjMzNDk0Mjl9.F5xVpjdYiGN_8_TL5PIm2ijg5AyUiXLrg6M6GkJN4D2KG3f-s-d4LuOgzxygvuy8Qbv2eWwkY9UY_RaBDpkWLQ"
}
```

---

#### 10. 刷新Token

```bash
curl -X POST http://localhost:8080/api/users/refresh-token \
  -H "Content-Type: application/json" \
  -d '{
    "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJuZXd1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYzMjYzMDI5LCJleHAiOjE3NjMzNDk0Mjl9.F5xVpjdYiGN_8_TL5PIm2ijg5AyUiXLrg6M6GkJN4D2KG3f-s-d4LuOgzxygvuy8Qbv2eWwkY9UY_RaBDpkWLQ"
  }'
```

**预期输出:**
```json
{
  "token": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJuZXd1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYzMjYzMDI5LCJleHAiOjE3NjMzNDk0Mjl9.F5xVpjdYiGN_8_TL5PIm2ijg5AyUiXLrg6M6GkJN4D2KG3f-s-d4LuOgzxygvuy8Qbv2eWwkY9UY_RaBDpkWLQ",
  "message": "Token refreshed successfully, new token valid for 24 hours"
}
```

---

## 错误处理

### 常见错误响应

#### 400 Bad Request - 验证错误

```json
{
  "status": 400,
  "message": "Validation failed: Password must contain uppercase, lowercase letters and numbers",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

**常见验证错误:**
- 邮箱格式不正确
- 密码长度必须在6-50个字符之间
- 密码必须包含大小写字母和数字
- 验证码必须是6位数字
- 密码不匹配

---

#### 404 Not Found

```json
{
  "status": 404,
  "message": "Invalid email or password",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

**常见404错误:**
- 用户不存在
- 邮箱或密码错误
- 验证码不存在或已过期

---

#### 409 Conflict - 邮箱已存在

```json
{
  "status": 409,
  "message": "Email already exists: user@example.com",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

---

#### 500 Internal Server Error

```json
{
  "status": 500,
  "message": "Token is invalid or expired, cannot refresh",
  "timestamp": "2025-11-16T11:17:09.817449"
}
```

---

## 安全最佳实践

### 1. 密码安全

- ✅ 密码使用BCrypt加密
- ✅ 密码不以明文存储
- ✅ 密码必须包含大小写字母和数字
- ✅ 最小密码长度为6个字符

### 2. Token安全

- ✅ JWT Token使用HS512算法签名
- ✅ Token有效期为24小时
- ✅ Token应安全存储在客户端
- ✅ 生产环境必须使用HTTPS

**Token存储建议:**
- Web应用使用`localStorage`
- 移动应用使用安全存储
- 不要在没有HttpOnly标志的Cookie中存储Token

### 3. 验证码安全

- ✅ 验证码是6位随机数字
- ✅ 验证码5分钟后过期
- ✅ 验证码存储在Redis中,自动过期
- ✅ 验证成功后立即删除验证码
- ✅ 不同场景使用不同验证码(REGISTER、RESET_PASSWORD)

### 4. 邮件安全

- ✅ 验证码通过邮件发送
- ✅ 邮箱地址在发送前验证
- ✅ 每个邮箱每个场景只有一个验证码

### 5. API安全

- ✅ 所有密码在存储前验证
- ✅ 邮箱地址对每个用户唯一
- ✅ 注册和密码重置需要验证码
- ✅ 登录失败返回通用错误消息

---

## 测试清单

- [ ] 成功发送验证码
- [ ] 在开发模式下获取验证码
- [ ] 用有效数据注册用户
- [ ] 验证无效邮箱注册失败
- [ ] 验证弱密码注册失败
- [ ] 验证重复邮箱注册失败
- [ ] 用正确凭证登录
- [ ] 验证错误密码登录失败
- [ ] 验证不存在邮箱登录失败
- [ ] 发送密码重置验证码
- [ ] 成功重置密码
- [ ] 验证旧密码不再有效
- [ ] 验证新密码重置后有效
- [ ] 成功刷新Token
- [ ] 验证无效Token刷新失败
- [ ] 验证过期Token刷新失败

---

## 有用的链接

- **API文档**: http://localhost:8080/api/swagger-ui.html
- **OpenAPI规范**: http://localhost:8080/api/v3/api-docs
- **H2数据库控制台**: http://localhost:8080/api/h2-console

---

## 支持

如有问题或疑问:
1. 检查响应中的错误消息
2. 查看每个端点的验证规则
3. 确保提供了所有必需字段
4. 验证邮箱格式是否正确
5. 检查密码是否满足复杂性要求
6. 确保验证码有效且未过期

---

**最后更新:** 2025-11-16
**API版本:** 1.0.0
