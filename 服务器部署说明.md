# æœåŠ¡å™¨éƒ¨ç½²è¯´æ˜
## ğŸš€ æœåŠ¡å™¨éƒ¨ç½²ï¼ˆæ¨èï¼‰

æœåŠ¡å™¨ä¸Šéƒ¨ç½²ä½¿ç”¨æ ‡å‡†çš„ Docker å¤šé˜¶æ®µæ„å»ºï¼Œæ— éœ€æœ¬åœ°æ„å»º JARã€‚

---

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤

### 1. ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨

```bash
# æ–¹å¼ 1: ä½¿ç”¨ git
git clone https://your-repo.git
cd stoq-web-api-new

# æ–¹å¼ 2: ä½¿ç”¨ scp
scp -r stoq-web-api-new user@server:/path/to/
```

### 2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# å¤åˆ¶é…ç½®æ¨¡æ¿
cp .env.prod.example .env.prod

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .env.prod

# å¿…é¡»ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š
# - MYSQL_ROOT_PASSWORD
# - MYSQL_PASSWORD
# - SPRING_REDIS_PASSWORD
# - JWT_SECRETï¼ˆä½¿ç”¨ openssl rand -base64 64 ç”Ÿæˆï¼‰
# - SPRING_MAIL_USERNAME
# - SPRING_MAIL_PASSWORD
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# ç”Ÿäº§ç¯å¢ƒ
docker compose -f docker-compose.prod.yml up -d --build

# æˆ–å¼€å‘/æµ‹è¯•ç¯å¢ƒ
docker compose up -d --build
```

### 4. éªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker compose ps

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f app

# æµ‹è¯• API
curl http://localhost:8080/api/v3/api-docs
```

---

## ğŸ”§ æœ¬åœ°å¼€å‘ï¼ˆMac/Windowsï¼‰

æœ¬åœ°å¼€å‘ç¯å¢ƒç”±äºç½‘ç»œé—®é¢˜ï¼Œä½¿ç”¨æœ¬åœ°æ„å»ºæ–¹å¼ï¼š

```bash
# 1. æœ¬åœ°æ„å»º JAR
mvn clean package -DskipTests

# 2. ä½¿ç”¨ Dockerfile.local å¯åŠ¨
# docker-compose.yml å·²é…ç½®ä½¿ç”¨ Dockerfile.local

# 3. å¯åŠ¨æœåŠ¡
./start-dev.sh
```

---

## ğŸ“Š éƒ¨ç½²æ–¹å¼å¯¹æ¯”

| ç¯å¢ƒ | Dockerfile | æ„å»ºæ–¹å¼ | è¯´æ˜ |
|------|-----------|---------|------|
| **æœåŠ¡å™¨** | `Dockerfile` | Docker å†…æ„å»º | âœ… æ¨èï¼Œæ ‡å‡†æµç¨‹ |
| **æœ¬åœ°å¼€å‘** | `Dockerfile.local` | æœ¬åœ°æ„å»º JAR | âœ… é¿å…ç½‘ç»œé—®é¢˜ |

---

## ğŸ³ Dockerfile è¯´æ˜

### æœåŠ¡å™¨ä½¿ç”¨ï¼šDockerfileï¼ˆå¤šé˜¶æ®µæ„å»ºï¼‰

```dockerfile
# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºåº”ç”¨
FROM maven:3.8.6-openjdk-11 AS builder
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œåº”ç”¨
FROM eclipse-temurin:11-jre
COPY --from=builder /app/target/*.jar app.jar
ENTRYPOINT ["java", "-jar", "app.jar"]
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ ‡å‡† Docker æ„å»ºæµç¨‹
- âœ… æœ€ç»ˆé•œåƒä½“ç§¯å°
- âœ… ä¸éœ€è¦æœ¬åœ° Java/Maven
- âœ… é€‚åˆ CI/CD æµç¨‹

### æœ¬åœ°ä½¿ç”¨ï¼šDockerfile.localï¼ˆå•é˜¶æ®µï¼‰

```dockerfile
# ä½¿ç”¨æœ¬åœ°å·²æœ‰çš„é•œåƒ
FROM maven:3.8.6-openjdk-11-slim
WORKDIR /app
COPY target/*.jar app.jar
ENTRYPOINT ["java", "-jar", "app.jar"]
```

**ä¼˜ç‚¹ï¼š**
- âœ… é¿å…ç½‘ç»œé—®é¢˜
- âœ… ä½¿ç”¨æœ¬åœ°å·²æœ‰é•œåƒ
- âœ… æ„å»ºé€Ÿåº¦å¿«

---

## ğŸŒ ç”Ÿäº§ç¯å¢ƒé…ç½®

### docker-compose.prod.yml ç‰¹ç‚¹

1. **èµ„æºé™åˆ¶**
   ```yaml
   deploy:
     resources:
       limits:
         cpus: '2'
         memory: 2G
   ```

2. **å®‰å…¨é…ç½®**
   - Redis å¯†ç ä¿æŠ¤
   - æ•°æ®åº“ SSL è¿æ¥
   - ç¯å¢ƒå˜é‡ç®¡ç†

3. **æ—¥å¿—çº§åˆ«**
   - ROOT: WARN
   - åº”ç”¨: INFO

4. **JVM ä¼˜åŒ–**
   - æ›´å¤§çš„å†…å­˜é…ç½®
   - G1 åƒåœ¾å›æ”¶å™¨

---

## ğŸ“ å¸¸ç”¨å‘½ä»¤

### ç”Ÿäº§ç¯å¢ƒ

```bash
# å¯åŠ¨
docker compose -f docker-compose.prod.yml up -d --build

# åœæ­¢
docker compose -f docker-compose.prod.yml down

# æŸ¥çœ‹æ—¥å¿—
docker compose -f docker-compose.prod.yml logs -f app

# é‡å¯åº”ç”¨
docker compose -f docker-compose.prod.yml restart app

# æŸ¥çœ‹çŠ¶æ€
docker compose -f docker-compose.prod.yml ps
```

### å¼€å‘ç¯å¢ƒ

```bash
# å¯åŠ¨
./start-dev.sh

# åœæ­¢
./stop-dev.sh

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f app
```

---

## ğŸ”’ å®‰å…¨æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰å¿…é¡»æ£€æŸ¥

- [ ] ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç 
- [ ] ç”Ÿæˆå¼º JWT å¯†é’¥
- [ ] é…ç½®çœŸå®é‚®ä»¶æœåŠ¡
- [ ] æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
- [ ] é…ç½® HTTPSï¼ˆä½¿ç”¨ Nginx åå‘ä»£ç†ï¼‰
- [ ] è®¾ç½®æ—¥å¿—è½®è½¬
- [ ] é…ç½®æ•°æ®åº“å¤‡ä»½

### ç”Ÿæˆå¼ºå¯†ç 

```bash
# ç”Ÿæˆ JWT å¯†é’¥
openssl rand -base64 64

# ç”Ÿæˆéšæœºå¯†ç 
openssl rand -base64 32
```

---

## ğŸ¯ CI/CD é›†æˆ

### GitLab CI ç¤ºä¾‹

```yaml
deploy:
  stage: deploy
  script:
    - docker compose -f docker-compose.prod.yml up -d --build
  only:
    - main
```

### GitHub Actions ç¤ºä¾‹

```yaml
- name: Deploy
  run: |
    docker compose -f docker-compose.prod.yml up -d --build
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹èµ„æºä½¿ç”¨

```bash
docker stats
```

### å¤‡ä»½æ•°æ®åº“

```bash
docker compose exec mysql mysqldump -u root -p${MYSQL_ROOT_PASSWORD} stoqdb > backup.sql
```

### æ¢å¤æ•°æ®åº“

```bash
docker compose exec -T mysql mysql -u root -p${MYSQL_ROOT_PASSWORD} stoqdb < backup.sql
```

---

## âœ… æ€»ç»“

| åœºæ™¯ | ä½¿ç”¨æ–¹å¼ | Dockerfile |
|------|---------|-----------|
| **æœåŠ¡å™¨éƒ¨ç½²** | `docker compose -f docker-compose.prod.yml up -d --build` | `Dockerfile` |
| **æœ¬åœ°å¼€å‘** | `./start-dev.sh` | `Dockerfile.local` |

**å…³é”®ç‚¹ï¼š**
- âœ… æœåŠ¡å™¨ä½¿ç”¨æ ‡å‡† Dockerfileï¼ˆå¤šé˜¶æ®µæ„å»ºï¼‰
- âœ… æœ¬åœ°ä½¿ç”¨ Dockerfile.localï¼ˆé¿å…ç½‘ç»œé—®é¢˜ï¼‰
- âœ… ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç 
- âœ… é…ç½® HTTPS å’Œé˜²ç«å¢™

---

**æœ€åæ›´æ–°ï¼š** 2025-11-22
